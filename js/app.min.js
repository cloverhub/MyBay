function compare(e,o,r){return e[r]==o[r]?0:e[r]<o[r]?-1:1}var Location=function(e,o){this.name=ko.observable(e.name),this.review=ko.observable(e.review),this.wiki=ko.observable(e.wiki),this.fs=ko.observable(e.fs),this.category=ko.observableArray(e.category),this.lat=ko.observable(e.lat),this.lng=ko.observable(e.lng),this.state=ko.observable(!1);var r=new google.maps.Marker({position:new google.maps.LatLng(e.lat,e.lng),icon:"img/marker-default.png"});google.maps.event.addListener(r,"click",function(e,o){return function(){o.showLocation(e)}}(this,o)),this.marker=r};locations.sort(function(e,o){return compare(e,o,"name")});var wikiSummary,Filter=function(e){this.name=ko.observable(e.name),this.on=ko.observable(!0)},ViewModel=function(){var e=this;e.searchFilter=ko.observable(""),e.selectedLocation=ko.observable(),e.state=!1,e.hasMarkers=!1,e.connectionError=ko.observable(!1),e.initialize=function(){var o=[],r=[];e.locationList=ko.observableArray([]),locations.forEach(function(r){e.locationList.push(new Location(r,e)),r.category.forEach(function(e){o.indexOf(e)<0&&o.push(e)})}),o.forEach(function(e){r.push(new Filter({name:e}))}),e.filters=ko.observableArray(r),e.selectedFilters=ko.computed(function(){var o=[];return ko.utils.arrayForEach(e.filters(),function(e){e.on()&&o.push(e.name())}),o}),e.filteredLocations=ko.computed(function(){var o=ko.observableArray([]),r=ko.observableArray([]);ko.utils.arrayForEach(e.locationList(),function(r){var i=r.category(),t=i.filter(function(o){return-1!=e.selectedFilters().indexOf(o)});t.length>0&&o.push(r)});var i=e.searchFilter().toLowerCase();return r=i?ko.utils.arrayFilter(o(),function(e){return-1!==e.name().toLowerCase().indexOf(i)}):o(),e.filterMarkers(r),r}),e.hasMarkers||e.showMarkers(),e.state=!0},e.filterMarkers=function(o){ko.utils.arrayForEach(e.locationList(),function(e){e.marker.setVisible(-1===o.indexOf(e)?!1:!0)})},e.toggleFilter=function(e){e.on(!e.on())},e.showLocation=function(o){if(Map.infoWindow.setContent(Map.infoWindowContent.replace("%title%",o.name()).replace("%description%",o.review())),Map.infoWindow.open(Map.map,o.marker),e.selectedLocation()&&e.selectedLocation().marker.setIcon("img/marker-default.png"),o.marker.setIcon("img/marker-selected.png"),e.connectionError(!1),o.state())e.selectedLocation(o);else{foursquareApi={clientId:"CHOZ3HJEWOJOGBDA1PFUA0Y3KP300XAQM2LAJVZVL1XHD5UE",clientSecret:"1Y2LSHK2TNKRWWVHC3F3E0E2G0L10RABG1Z5DNQQAR5UAFKR",ver:"20150601",baseUrl:"https://api.foursquare.com/v2/venues/"},$.ajax({url:foursquareApi.baseUrl+"search?ll="+o.lat()+","+o.lng()+"&intent=match&name="+o.name()+"&client_id="+foursquareApi.clientId+"&client_secret="+foursquareApi.clientSecret+"&v="+foursquareApi.ver}).done(function(r){var i=r.response.venues[0];"1"===o.fs()?(o.id=ko.observable(i.id),foursquareLink=ko.observable('<a href="http://foursquare.com/v/'+i.id+"?ref="+foursquareApi.clientId+'" target="_blank">more from Foursquare</a>'),o.url=i.hasOwnProperty("url")?ko.observable(i.url):null,o.phone=i.hasOwnProperty("contact")&&i.contact.hasOwnProperty("formattedPhone")?ko.observable(i.contact.formattedPhone):null,$.ajax({url:foursquareApi.baseUrl+o.id()+"/photos?client_id="+foursquareApi.clientId+"&client_secret="+foursquareApi.clientSecret+"&v="+foursquareApi.ver}).done(function(r){var i=r.response.photos.items;o.photo1=ko.observable(i[0].prefix+"height200"+i[0].suffix),o.photo2=ko.observable(i[1].prefix+"height200"+i[1].suffix),o.photo3=ko.observable(i[2].prefix+"height200"+i[2].suffix),o.photo4=ko.observable(i[3].prefix+"height200"+i[3].suffix),o.photo5=ko.observable(i[4].prefix+"height200"+i[4].suffix),o.photo6=ko.observable(i[5].prefix+"height200"+i[5].suffix),o.photo7=ko.observable(i[6].prefix+"height200"+i[6].suffix),o.photo8=ko.observable(i[7].prefix+"height200"+i[7].suffix),o.state(!0),e.selectedLocation(o)}).fail(function(){e.connectionError(!0),e.selectedLocation(o)})):(o.phone=null,o.url=null,o.foursquareLink=null,o.photo1=null,o.photo2=null,o.photo3=null,o.photo4=null,o.photo5=null,o.photo6=null,o.photo7=null,o.photo8=null,e.selectedLocation(o))});var r=setTimeout(function(){e.connectionError(!0)},6e3);$.ajax({url:"http://en.wikipedia.org/w/api.php?action=opensearch&format=json&search="+o.name()+"&limit=1&namespace=0&format=json",dataType:"jsonp"}).done(function(e){var i=e,t=i[1],a=i[2],n="http://en.wikipedia.org/wiki/"+t;o.wikiInfo=ko.observable(a),o.wikiUrl=ko.observable(n),"1"===o.wiki()&&(o.wikiSummary=ko.observable(a+'<a href="'+n+'" target="_blank"> ...more from Wikipedia</a>')),clearTimeout(r)})}},e.showMarkers=function(){ko.utils.arrayForEach(e.locationList(),function(e){e.marker.setMap(Map.map)}),e.hasMarkers=!0}},Map={map:{},infoWindow:new google.maps.InfoWindow({}),options:{center:{lat:37.8,lng:-122.3},zoom:10,maxZoom:15,minZoom:9,backgroundColor:"#B2D0FB"},infoWindowContent:'<div class="info-window"><div class="window-title">Why I dig %title%</div><hr><div class="window-description">%description%</div></div>',initialize:function(e){Map.map=new google.maps.Map(document.getElementById("map"),Map.options),e.state&&!e.hasMarkers&&e.showMarkers()}},viewModel=new ViewModel;$(document).ready(function(){viewModel.initialize(),ko.applyBindings(viewModel)}),google.maps.event.addDomListener(window,"load",Map.initialize(viewModel));