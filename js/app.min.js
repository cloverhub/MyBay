"use strict";function compare(e,o,n){return e[n]==o[n]?0:e[n]<o[n]?-1:1}var run=function(){"up"===Offline.state&&Offline.check(),Offline.options={checkOnLoad:!1,interceptRequests:!0,reconnect:{initialDelay:3},requests:!0}};setInterval(run,5e3);var Location=function(e,o){this.name=ko.observable(e.name),this.review=ko.observable(e.review),this.wiki=ko.observable(e.wiki),this.fs=ko.observable(e.fs),this.category=ko.observableArray(e.category),this.lat=ko.observable(e.lat),this.lng=ko.observable(e.lng),this.state=ko.observable(!1);var n=new google.maps.Marker({position:new google.maps.LatLng(e.lat,e.lng),animation:google.maps.Animation.DROP,icon:"img/marker-default.png"});google.maps.event.addListener(n,"click",function(e,o){return function(){this.marker=null,o.showLocation(e)}}(this,o)),this.marker=n},Map={map:{},infoWindow:new google.maps.InfoWindow({}),options:{center:{lat:37.8,lng:-122.3},zoom:10,maxZoom:15,minZoom:9,backgroundColor:"#b2d0fb"},infoWindowContent:'<div class="info-window"><div class="window-title">%title%</div><hr class="horizontal-line"></div>',initialize:function(e){Map.map=new google.maps.Map(document.getElementById("map"),Map.options),e.state&&!e.hasMarkers&&e.showMarkers()}};locations.sort(function(e,o){return compare(e,o,"name")}),$(window).load(function(){$("#loading").hide()});var wikiSummary,foursquareApi,foursquareLink,Filter=function(e){this.name=ko.observable(e.name),this.on=ko.observable(!0)},ViewModel=function(){function e(){$("nav").addClass("open"),$("this").addClass("close-btn")}function o(){$("nav").removeClass("open")}var n=this;n.searchFilter=ko.observable(""),n.selectedLocation=ko.observable(),n.state=!1,n.hasMarkers=!1,n.connectionError=ko.observable(!1),n.initialize=function(){var e=[],o=[];n.locationList=ko.observableArray([]),locations.forEach(function(o){n.locationList.push(new Location(o,n)),o.category.forEach(function(o){e.indexOf(o)<0&&e.push(o)})}),e.forEach(function(e){o.push(new Filter({name:e}))}),n.filters=ko.observableArray(o),n.selectedFilters=ko.computed(function(){var e=[];return ko.utils.arrayForEach(n.filters(),function(o){o.on()&&e.push(o.name())}),Map.infoWindow.close(),e}),n.filteredLocations=ko.computed(function(){var e=ko.observableArray([]),o=ko.observableArray([]);Map.infoWindow.close(),ko.utils.arrayForEach(n.locationList(),function(o){var i=o.category(),t=i.filter(function(e){return-1!=n.selectedFilters().indexOf(e)});t.length>0&&e.push(o)});var i=n.searchFilter().toLowerCase();return o=i?ko.utils.arrayFilter(e(),function(e){return-1!==e.name().toLowerCase().indexOf(i)}):e(),n.filterMarkers(o),o}),n.hasMarkers||n.showMarkers(),n.state=!0},n.filterMarkers=function(e){ko.utils.arrayForEach(n.locationList(),function(o){o.marker.setVisible(-1===e.indexOf(o)?!1:!0)})},n.toggleFilter=function(e){e.on(!e.on())},n.clearMarkers=function(){ko.utils.arrayForEach(n.locationList(),function(e){e.marker.setVisible(!1)})},$(document).ready(function(){$(".menu-btn").click(function(){o()})}),n.clearLocation=function(){Map.infoWindow.close(),Map.infoWindow.setContent(null)},n.showLocation=function(o){if(e(),Map.infoWindow.open(Map.map,o.marker),Map.infoWindow.setContent(Map.infoWindowContent.replace("%title%",o.name())),n.connectionError(!1),o.state())n.selectedLocation(o);else{foursquareApi={clientId:"CHOZ3HJEWOJOGBDA1PFUA0Y3KP300XAQM2LAJVZVL1XHD5UE",clientSecret:"II50TC3MPWNJ0DEVPFWXNEQV4USNZXFNWSXXSOW05OJYFTC4",ver:"20150601",baseUrl:"https://api.foursquare.com/v2/venues/"};var i=setTimeout(function(){n.connectionError(!0)},6e3);if($.ajax({url:foursquareApi.baseUrl+"search?ll="+o.lat()+","+o.lng()+"&intent=match&name="+o.name()+"&client_id="+foursquareApi.clientId+"&client_secret="+foursquareApi.clientSecret+"&v="+foursquareApi.ver}).done(function(e){var t=e.response.venues[0];"1"===o.fs()?(o.id=ko.observable(t.id),foursquareLink=ko.observable('<a href="http://foursquare.com/v/'+t.id+"?ref="+foursquareApi.clientId+'" target="_blank">'+o.name()+" on Foursquare</a>"),o.url=t.hasOwnProperty("url")?ko.observable(t.url):null,o.phone=t.hasOwnProperty("contact")&&t.contact.hasOwnProperty("formattedPhone")?ko.observable(t.contact.formattedPhone):null,$.ajax({url:foursquareApi.baseUrl+o.id()+"/photos?client_id="+foursquareApi.clientId+"&client_secret="+foursquareApi.clientSecret+"&v="+foursquareApi.ver}).done(function(e){var i=e.response.photos.items;o.photo1=ko.observable(i[0].prefix+"height300"+i[0].suffix),o.photo2=ko.observable(i[1].prefix+"height300"+i[1].suffix),o.photo3=ko.observable(i[2].prefix+"height300"+i[2].suffix),o.photo4=ko.observable(i[3].prefix+"height300"+i[3].suffix),o.photo5=ko.observable(i[4].prefix+"height300"+i[4].suffix),o.photo6=ko.observable(i[5].prefix+"height300"+i[5].suffix),o.photo7=ko.observable(i[6].prefix+"height300"+i[6].suffix),o.photo8=ko.observable(i[7].prefix+"height300"+i[7].suffix),o.state(!0),n.selectedLocation(o)}).fail(function(){n.connectionError(!0),n.selectedLocation(o)})):(o.phone=null,o.url=null,o.foursquareLink=null,o.photo1=null,o.photo2=null,o.photo3=null,o.photo4=null,o.photo5=null,o.photo6=null,o.photo7=null,o.photo8=null,n.selectedLocation(o)),clearTimeout(i)}),"1"===o.wiki()){var t=setTimeout(function(){n.connectionError(!0)},6e3);$.ajax({url:"http://en.wikipedia.org/w/api.php?action=opensearch&format=json&search="+o.name()+"&limit=1&namespace=0&format=json",dataType:"jsonp"}).done(function(e){var n=e,i=n[1],r=n[2],a="http://en.wikipedia.org/wiki/"+i;o.wikiInfo=ko.observable(r),o.wikiUrl=ko.observable(a),o.wikiSummary=ko.observable("<h3>Wikipedia says</h3><p>"+r+'<a href="'+a+'" target="_blank"> ...more from Wikipedia</a></p>'),clearTimeout(t)})}}},n.showMarkers=function(){ko.utils.arrayForEach(n.locationList(),function(e){e.marker.setMap(Map.map)}),n.hasMarkers=!0}},viewModel=new ViewModel;$(document).ready(function(){viewModel.initialize(),ko.applyBindings(viewModel)}),google.maps.event.addDomListener(window,"load",Map.initialize(viewModel));